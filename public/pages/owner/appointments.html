<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/assets/logo-sm.png" />
    <title>Owner - Messages</title>
    <link rel="stylesheet" href="/styles/admin.css" />
    <link rel="stylesheet" href="/styles/owner/appointment.css" />
    <script type="module" src="/js/admin.js"></script>
    <script type="module" src="/js/owner/appointment.js"></script>
  </head>
  <body>
    <div id="main">
      <div id="sidebar-container"></div>

      <div class="main-content">
        <h1 id="current-listing-header">Appointments</h1>

        <select id="filter-status">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="accepted">Accepted</option>
          <option value="declined">Declined</option>
        </select>
    
        <div id="appointments-container"></div>
    
        <template id="appointment-card-template">
          <div class="appointment-card">
            <p><strong>Name:</strong> <span class="renter-name"></span></p>
            <p><strong>Phone:</strong> <span class="renter-phone"></span></p>
            <p>
              <strong>Preferred Date:</strong> <span class="preferred-date"></span>
            </p>
            <p>
              <strong>Preferred Time:</strong> <span class="preferred-time"></span>
            </p>
            <p><strong>Status:</strong> <span class="appointment-status"></span></p>
            <button class="accept-button">Accept</button>
            <button class="decline-button">Decline</button>
          </div>
        </template>
    
        <template id="loading-indicator-template">
          <div class="loading">Loading appointments...</div>
        </template>
    
        <template id="empty-state-template">
          <div class="empty">No appointments found.</div>
        </template>
      </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        updateDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCV7GHk-wK5bhDg2Inqm7vJqTYjl1TTTNw",
        authDomain: "dormies-b47b7.firebaseapp.com",
        projectId: "dormies-b47b7",
        storageBucket: "dormies-b47b7.appspot.com",
        messagingSenderId: "443577320462",
        appId: "1:443577320462:web:0a418fa107fbd01bd1285f",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const appointmentsContainer = document.getElementById(
        "appointments-container"
      );
      const currentListingHeader = document.getElementById(
        "current-listing-header"
      );
      const filterStatus = document.getElementById("filter-status");

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      async function fetchSchedulesForOwner() {
        showLoadingIndicator();

        try {
          const user = auth.currentUser;
          if (!user) {
            console.error("No user is logged in");
            showEmptyState();
            return;
          }

          const ownerId = user.uid;
          console.log("Fetching schedules for owner with UID:", ownerId);

          const schedulesQuery = query(
            collection(db, "schedules"),
            where("ownerId", "==", ownerId)
          );

          const schedulesSnapshot = await getDocs(schedulesQuery);

          if (schedulesSnapshot.empty) {
            showEmptyState();
            currentListingHeader.textContent = "No Schedules Found";
            return;
          }

          appointmentsContainer.innerHTML = "";

          schedulesSnapshot.forEach(async (scheduleDoc) => {
            const scheduleData = scheduleDoc.data();
            scheduleData.id = scheduleDoc.id; // Add document ID for reference

            renderScheduleCard(scheduleData);
          });
        } catch (error) {
          console.error("Error fetching schedules: ", error);
          showEmptyState();
        }
      }

      function renderScheduleCard(scheduleData) {
        const scheduleCard = document.createElement("div");
        scheduleCard.classList.add("appointment-card");

        const statusTag = scheduleData.status
          ? `<span class="status-tag status-${scheduleData.status}">${
              scheduleData.status.charAt(0).toUpperCase() +
              scheduleData.status.slice(1)
            }</span>`
          : `<button class="accept-button">Accept</button><button class="decline-button">Decline</button>`;

        scheduleCard.innerHTML = `
    <p><strong>Status:</strong> ${statusTag}</p>
    <p><strong>Name:</strong> ${scheduleData.name || "Unknown Renter"}</p>
    <p><strong>Phone:</strong> ${scheduleData.renterPhone || "N/A"}</p>
    <p><strong>Preferred Date:</strong> ${formatDate(
      scheduleData.preferredDate
    )}</p>
    <p><strong>Preferred Time:</strong> ${
      scheduleData.preferredTime || "N/A"
    }</p>
  `;

        appointmentsContainer.appendChild(scheduleCard);

        const acceptButton = scheduleCard.querySelector(".accept-button");
        const declineButton = scheduleCard.querySelector(".decline-button");

        if (acceptButton) {
          acceptButton.addEventListener("click", () =>
            updateScheduleStatus(scheduleData.id, "accepted")
          );
        }

        if (declineButton) {
          declineButton.addEventListener("click", () =>
            updateScheduleStatus(scheduleData.id, "declined")
          );
        }
      }

      async function updateScheduleStatus(scheduleId, status) {
        try {
          const scheduleRef = doc(db, "schedules", scheduleId);
          await updateDoc(scheduleRef, {
            status: status,
          });

          fetchSchedulesForOwner();
        } catch (error) {
          console.error("Error updating schedule status: ", error);
        }
      }

      function showLoadingIndicator() {
        appointmentsContainer.innerHTML = "<p>Loading schedules...</p>";
      }

      function showEmptyState() {
        appointmentsContainer.innerHTML =
          "<p>No schedules found. Please check back later.</p>";
      }

      function filterSchedulesByStatus(status) {
        const schedules = Array.from(appointmentsContainer.children);

        schedules.forEach((schedule) => {
          const statusText = schedule.querySelector(".status-tag")
            ? schedule.querySelector(".status-tag").textContent.toLowerCase()
            : "pending";
          if (status === "all" || statusText === status) {
            schedule.style.display = "block";
          } else {
            schedule.style.display = "none";
          }
        });
      }

      filterStatus.addEventListener("change", (event) => {
        filterSchedulesByStatus(event.target.value);
      });

      document.addEventListener("DOMContentLoaded", function () {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            fetchSchedulesForOwner();
          } else {
            showEmptyState();
          }
        });
      });
    </script>
  </body>
</html>
